<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="zomo" />
    <meta name="keywords" content="zomo" />
    <meta name="author" content="zomo" />
    <link rel="manifest" href="../manifest.json" />
    <link rel="icon" href="../assets/images/logo/favicon.png" type="image/x-icon" />
    <title>zomo App</title>
    <link rel="apple-touch-icon" href="../assets/images/logo/favicon.png" />
    <meta name="theme-color" content="#ff8d2f" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-title" content="zomo" />
    <meta name="msapplication-TileImage" content="../assets/images/logo/favicon.png" />
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <style>
        * {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        .cart-container {
            padding: 20px;
        }

        .cart-item {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .cart-item img {
            width: 60px;
            height: 60px;
            border-radius: 5px;
            margin-right: 20px;
            cursor: pointer;
        }

        .item-details {
            flex-grow: 1;
        }

        .item-quantity {
            display: flex;
            align-items: center;
        }

        .quantity-btn {
            background-color: #4CAF50;
            border: none;
            padding: 10px 10px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
            color: #fff;
            transition: background-color 0.3s ease;
        }

        .quantity-btn:disabled {
            background-color: #ddd;
            cursor: not-allowed;
        }

        .quantity {
            margin: 0 10px;
            font-size: 16px;
        }

        .subtotal {
            font-size: 18px;
            font-weight: bold;
            text-align: right;
            margin-top: 20px;
        }

        .bill-details {
            background-color: #fffbcc;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 20px;
        }

        .original-price {
            text-decoration: line-through;
            color: #999;
        }

        .savings {
            font-size: 16px;
            color: #4CAF50;
            font-weight: bold;
        }

        .proceed {
            text-align: center;
            padding: 20px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .proceed-btn {
            background-color: #4CAF50;
            color: #fff;
            border: none;
            padding: 15px 30px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 18px;
        }

        .proceed-btn:hover {
            background-color: #45a049;
        }

        button {
            background-color: #4CAF50;
            color: #fff;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
        }

        button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div class="cart-container" id="cart-container">
        <!-- Cart items will be dynamically added here -->
    </div>
    <div id="empty-cart-message" style="display: none;">Your cart is empty!</div>
    <div class="subtotal" id="total-cost">Subtotal: ₹0.00</div>
    <div class="bill-details" id="bill-details" style="display: none;">
        <div class="savings" id="total-savings">You saved: ₹0.00</div>
    </div>
    <button id="proceed-btn">Proceed to Payment</button>
    <button id="continue-shopping-btn">Continue Shopping</button>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
    const cartContainer = document.getElementById('cart-container');
    const emptyCartMessage = document.getElementById('empty-cart-message');
    const totalCostElement = document.getElementById('total-cost');
    const totalSavingsElement = document.getElementById('total-savings');
    const billDetails = document.getElementById('bill-details');

    function fetchCart() {
        const token = localStorage.getItem('token'); // Assuming token is stored in localStorage
        if (!token) {
            console.error('No token found, authorization required.');
            alert('You need to log in first.');
            window.location.href = '/login.html';
            return;
        }

        fetch('https://m1wala1.onrender.com/api/cart', {
            headers: {
                'Content-Type': 'application/json',
                'x-auth-token': token
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(cartData => {
            //console.log('Cart items retrieved:', cartData);
            renderCartItems(cartData);
        })
        .catch(error => {
            console.error('Error fetching cart items:', error);
            if (error.message.includes('401')) {
                alert('Unauthorized. Please log in again.');
            } else {
                alert('Error fetching cart items. Please try again later.');
            }
        });
    }

    function renderCartItems(cartData) {
    const { cartItems, subtotal } = cartData;
    let totalSavings = 0;

    cartContainer.innerHTML = '';
    if (!Array.isArray(cartItems) || cartItems.length === 0) {
        emptyCartMessage.style.display = 'block';
        return;
    }

    emptyCartMessage.style.display = 'none';

    cartItems.forEach(item => {
        if (!item._id || !item.subcategoryId || !item.categoryId) {
            console.error('Invalid cart item:', item);
            return;
        }
        console.log('Rendering item with ID:', item._id);
        const itemDiv = document.createElement('div');
        itemDiv.classList.add('cart-item');
        itemDiv.dataset.id = item._id; // Use data attribute to store cart item ID
        const savings = (item.originalPrice - item.price) * item.quantity;
        totalSavings += savings;

        itemDiv.innerHTML = `
            <img src="${item.imageUrl}" alt="${item.productName}" />
            <div class="item-details">
                <p>${item.productName}</p>
                <p><span class="original-price">₹${item.originalPrice.toFixed(2)}</span> ₹${item.price.toFixed(2)}</p>
                <p>${item.quantityValue !== null && item.quantityUnit !== null ? `${item.quantityValue} ${item.quantityUnit}/₹${item.price.toFixed(2)}` : 'N/A'}</p>
                <div class="item-quantity">
                    <button class="quantity-btn decrease-btn" data-id="${item._id}">-</button>
                    <span class="quantity">${item.quantity}</span>
                    <button class="quantity-btn increase-btn" data-id="${item._id}">+</button>
                </div>
            </div>
        `;
        cartContainer.appendChild(itemDiv);

        const decreaseBtn = itemDiv.querySelector('.decrease-btn');
        const increaseBtn = itemDiv.querySelector('.increase-btn');
        const productImage = itemDiv.querySelector('img');

        decreaseBtn.addEventListener('click', () => updateQuantity(item._id, 'decrease'));
        increaseBtn.addEventListener('click', () => updateQuantity(item._id, 'increase'));
        productImage.addEventListener('click', () => redirectToProduct(item.productId, item.subcategoryId, item.categoryId));
    });

    // Update subtotal display
    totalCostElement.innerHTML = `Subtotal: ₹${subtotal.toFixed(2)}`;
    // Update total savings display
    if (totalSavings > 0) {
        billDetails.style.display = 'block';
        totalSavingsElement.innerHTML = `You saved: ₹${totalSavings.toFixed(2)}`;
    } else {
        billDetails.style.display = 'none';
    }
}

function updateQuantity(itemId, action) {
    const token = localStorage.getItem('token');
    if (!token) {
        console.error('No token found, authorization required.');
        alert('You need to log in first.');
        return;
    }

    if (!itemId) {
        console.error('Invalid item ID:', itemId);
        alert('Invalid item ID. Please try again.');
        return;
    }

    console.log(`Updating quantity for item ${itemId}, action: ${action}`);
    fetch(`https://m1wala1.onrender.com/api/cart/${itemId}/${action}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'x-auth-token': token
        }
    })
    .then(response => {
        if (!response.ok) {
            console.error(`HTTP error! Status: ${response.status}`);
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
    })
    .then(cartData => {
        console.log('Updated cart items:', cartData); // Log cartData here
        renderCartItems(cartData);
    })
    .catch(error => {
        console.error('Error updating cart item quantity:', error);
        alert('Error updating cart item quantity. Please try again later.');
    });
}

    function redirectToProduct(productId, subcategoryId, categoryId) {
        if (productId && subcategoryId && categoryId) {
            window.location.href = `grocery-home.html?categoryId=${categoryId}&subcategoryId=${subcategoryId}&productId=${productId}`;
        } else {
            console.error('Invalid product, subcategory, or category ID:', productId, subcategoryId, categoryId);
            alert('Invalid product or subcategory. Please try again.');
        }
    }

    function proceedToPayment() {
        const subtotalText = totalCostElement.textContent;
        const totalCost = parseFloat(subtotalText.split('₹')[1]);
        localStorage.setItem('totalCost', totalCost);
        window.location.href = "/payment-method.html";
    }

    function continueShopping() {
        window.location.href = "/grocery-home.html";
    }

    document.getElementById('proceed-btn').addEventListener('click', proceedToPayment);
    document.getElementById('continue-shopping-btn').addEventListener('click', continueShopping);

    fetchCart();
});
    </script>
</body>
</html>
