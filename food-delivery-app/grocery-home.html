<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="m1wala" />
    <meta name="keywords" content="m1wala" />
    <meta name="author" content="m1wala" />
    <link rel="manifest" href="../manifest.json" />
    <link rel="icon" href="../assets/images/logo/favicon.png" type="image/x-icon" />
    <title>m1wala instamart</title>
    <link rel="apple-touch-icon" href="../assets/images/logo/favicon.png" />
    <meta name="theme-color" content="#ff8d2f" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-title" content="m1wala" />
    <meta name="msapplication-TileImage" content="../assets/images/logo/favicon.png" />
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Grocery Shopping</title>
    <style>
       /* Your existing styles here */
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
}

header {
    background-color: #f8f8f8;
    padding: 10px;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 1000;
}

#search {
    padding: 5px;
    width: 80%;
    margin-top: 10px;
}

main {
    display: flex;
    padding: 10px;
}

nav ul {
    list-style-type: none;
    padding: 0;
    background-color: #333;
    overflow: hidden;
}

nav ul li {
    float: left;
}

nav ul li a {
    display: block;
    padding: 10px;
    color: white;
    text-align: center;
    text-decoration: none;
}

nav ul li a:hover {
    background-color: #111;
}

main {
    display: flex;
    padding: 10px;
}

aside {
    width: 20%;
}

aside ul {
    list-style-type: none;
    padding: 0;
}

aside ul li {
    margin-bottom: 10px;
}

aside ul li a {
    text-decoration: none;
    color: #333;
    display: block;
    padding: 10px;
    background-color: #f8f8f8;
    border: 1px solid #ddd;
    border-radius: 5px;
}

aside ul li a:hover {
    background-color: #ddd;
}

.product-grid {
    width: 80%;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
    padding-left: 20px;
}

.product-item {
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 10px;
    text-align: center;
    background-color: #fff;
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.product-item img {
    max-width: 100%;
    height: auto;
    border-bottom: 1px solid #ddd;
    padding-bottom: 10px;
    margin-bottom: 10px;
}

.product-item .discount {
    position: absolute;
    top: 10px;
    right: 10px;
    background-color: #ff5c5c;
    color: white;
    padding: 5px;
    border-radius: 5px;
    font-weight: bold;
}

.product-item .prices {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
}

.product-item .original-price {
    text-decoration: line-through;
    color: #888;
}

.product-item .discounted-price {
    color: #28a745;
    font-weight: bold;
}

.product-item button {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 10px;
    border-radius: 5px;
    cursor: pointer;
}

.product-item button:hover {
    background-color: #218838;
}

.product-item.unavailable {
    background-color: #f8d7da;
    opacity: 0.6;
    pointer-events: none;
}

.product-item .not-available {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(255, 255, 255, 0.8);
    color: red;
    font-size: 1.5em;
    font-weight: bold;
    text-align: center;
}

/* Modal styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1001; /* Make sure it's above the header */
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
    padding-top: 60px;
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    box-sizing: border-box;
    max-width: 600px; /* Limit the width to avoid clumsiness */
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}

.quantity-option {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    border-bottom: 1px solid #ccc;
    padding-bottom: 10px;
}

.quantity-option span {
    margin: 0 10px;
}

.quantity-option button {
    background-color: #4CAF50; /* Green color for "Add to Cart" button */
    border: none;
    color: white;
    padding: 5px 10px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 14px;
    cursor: pointer;
    border-radius: 4px;
    transition: background-color 0.3s;
}

.quantity-option button:hover {
    background-color: #45a049;
}

.navbar-menu {
    position: fixed;
    bottom: 0;
    width: 100%;
    background-color: #333;
    z-index: 1000;
}

.navbar-menu ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    justify-content: space-around;
}

.navbar-menu li {
    flex: 1;
    text-align: center;
}

.navbar-menu a {
    color: rgba(34, 139, 34, 1);
    text-decoration: none;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 10px;
}

.navbar-menu a.active {
    color: rgba(0, 123, 255, 1);
}

.navbar-menu img {
    max-width: 24px;
    margin-bottom: 5px;
}

    </style>
</head>
<body>
    <header>
        <h1>Grocery Shopping</h1>
        <input type="text" id="search" placeholder="Search...">
    </header>
    <nav>
        <ul id="categories">
            <li data-category="vegetables-fruits"><a href="#">Vegetables & Fruits</a></li>
            <li data-category="dairy"><a href="#">Dairy</a></li>
            <li data-category="meat"><a href="#">Meat</a></li>
        </ul>
    </nav>
    <main>
        <aside id="subcategories"></aside>
        <section class="product-grid"></section>
    </main>
    <!-- Bottom Navbar -->
    <div class="navbar-menu">
        <ul>
            <li class="active">
                <a href="grocery-home.html" class="icon">
                    <span>Grocery</span>
                </a>
            </li>
            <li class="active">
                <a href="cart.html" class="icon">
                    <span>Cart</span>
                </a>
            </li>
            <li>
                <a href="profile.html" class="icon">
                    <span>Profile</span>
                </a>
            </li>
        </ul>
    </div>

    <!-- Modal for product options -->
    <div id="productOptionsModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="productOptionsContent"></div>
        </div>
    </div>

    <script>
        const subcategories = {
            "vegetables-fruits": ["Leafy Greens", "Root Vegetables", "Fruits", "Seasonal Fruits"],
            "dairy": ["Milk", "Curd", "Ghee"],
            "meat": ["Country Chicken", "Mutton", "Fish"]
        };

        async function fetchProducts() {
            try {
                const response = await fetch('/products');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching products:', error);
                return [];
            }
        }

        function calculateDiscountPercentage(originalPrice, discountedPrice) {
            const discount = originalPrice - discountedPrice;
            const percentage = (discount / originalPrice) * 100;
            return Math.round(percentage);
        }

        function renderSubcategories(category) {
            const subcategoryList = document.getElementById('subcategories');
            subcategoryList.innerHTML = '';

            if (subcategories[category]) {
                const subcategoryUl = document.createElement('ul');
                subcategories[category].forEach(subcategory => {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="#" onclick="renderProductsBySubcategory('${subcategory}')">${subcategory}</a>`;
                    subcategoryUl.appendChild(li);
                });
                subcategoryList.appendChild(subcategoryUl);

                // Automatically render products for the first subcategory
                renderProductsBySubcategory(subcategories[category][0]);
            }
        }

        async function renderProductsBySubcategory(subcategory) {
            try {
                const products = await fetchProducts();
                const productGrid = document.querySelector('.product-grid');
                productGrid.innerHTML = '';

                const filteredProducts = products.filter(product => product.subcategory === subcategory);

                if (filteredProducts.length === 0) {
                    productGrid.innerHTML = '<p>No products found in this subcategory.</p>';
                } else {
                    filteredProducts.forEach(product => {
                        const originalPrice = parseFloat(product.originalPrice);
                        const discountedPrice = parseFloat(product.discountedPrice);

                        if (isNaN(originalPrice) || isNaN(discountedPrice)) {
                            console.error('Invalid price data', product);
                            return;
                        }

                        const discountPercentage = calculateDiscountPercentage(originalPrice, discountedPrice);

                        const productItem = document.createElement('div');
                        productItem.className = 'product-item';

                        const productImage = document.createElement('img');
                        productImage.src = `${product.image}`;
                        productImage.alt = product.name;

                        const productName = document.createElement('h3');
                        productName.textContent = product.name;

                        const discountBadge = document.createElement('div');
                        discountBadge.className = 'discount';
                        discountBadge.textContent = `${discountPercentage}% OFF`;

                        const pricesDiv = document.createElement('div');
                        pricesDiv.className = 'prices';

                        const originalPriceElem = document.createElement('span');
                        originalPriceElem.className = 'original-price';
                        originalPriceElem.textContent = `₹${originalPrice.toFixed(2)}`;

                        const discountedPriceElem = document.createElement('span');
                        discountedPriceElem.className = 'discounted-price';
                        discountedPriceElem.textContent = `₹${discountedPrice.toFixed(2)}`;

                        const quantityDiv = document.createElement('div');
                        quantityDiv.className = 'quantity';

                        if (product.quantities && product.quantities.length > 1) {
                            quantityDiv.textContent = `${product.quantities[0].quantityValue} ${product.quantities[0].quantityUnit}`;

                            productItem.appendChild(discountBadge);
                            productItem.appendChild(productImage);
                            productItem.appendChild(productName);
                            productItem.appendChild(quantityDiv);
                            productItem.appendChild(pricesDiv);

                            const optionsButton = document.createElement('button');
                            optionsButton.textContent = 'Options';
                            optionsButton.onclick = () => showProductOptions(product);
                            productItem.appendChild(optionsButton);
                        } else {
                            const productButton = document.createElement('button');
                            productButton.textContent = 'Add to Cart';
                            productButton.onclick = () => addToCart(product);

                            if (product.quantities && product.quantities.length === 1) {
                                quantityDiv.textContent = `${product.quantities[0].quantityValue} ${product.quantities[0].quantityUnit}`;
                            }

                            productItem.appendChild(discountBadge);
                            productItem.appendChild(productImage);
                            productItem.appendChild(productName);
                            productItem.appendChild(quantityDiv);
                            productItem.appendChild(pricesDiv);
                            productItem.appendChild(productButton);
                        }

                        pricesDiv.appendChild(originalPriceElem);
                        pricesDiv.appendChild(discountedPriceElem);

                        if (!product.available) {
                            const notAvailableOverlay = document.createElement('div');
                            notAvailableOverlay.className = 'not-available';
                            notAvailableOverlay.textContent = 'Product Not Available';
                            productItem.appendChild(notAvailableOverlay);
                        }

                        productGrid.appendChild(productItem);
                    });
                }
            } catch (error) {
                console.error('Error rendering products by subcategory:', error);
            }
        }

        function showProductOptions(product) {
            const modal = document.getElementById('productOptionsModal');
            const content = document.getElementById('productOptionsContent');
            content.innerHTML = '';

            product.quantities.forEach(quantity => {
                const quantityDiv = document.createElement('div');
                quantityDiv.className = 'quantity-option';

                const quantityText = document.createElement('span');
                quantityText.textContent = `${quantity.quantityValue} ${quantity.quantityUnit}`;

                const originalPrice = parseFloat(quantity.originalPrice || product.originalPrice);
                const discountedPrice = parseFloat(quantity.discountedPrice || quantity.price);

                if (isNaN(originalPrice) || isNaN(discountedPrice)) {
                    console.error('Invalid price data', quantity);
                    return;
                }

                const originalPriceElem = document.createElement('span');
                originalPriceElem.className = 'original-price';
                originalPriceElem.textContent = `₹${originalPrice.toFixed(2)}`;

                const discountedPriceElem = document.createElement('span');
                discountedPriceElem.className = 'discounted-price';
                discountedPriceElem.textContent = `₹${discountedPrice.toFixed(2)}`;

                const addButton = document.createElement('button');
                addButton.textContent = 'Add to Cart';
                addButton.onclick = () => addToCart(product, quantity);

                quantityDiv.appendChild(quantityText);
                quantityDiv.appendChild(originalPriceElem);
                quantityDiv.appendChild(discountedPriceElem);
                quantityDiv.appendChild(addButton);

                content.appendChild(quantityDiv);
            });

            modal.style.display = 'block';
        }

        async function addToCart(product, quantity = null) {
            const item = {
                name: product.name,
                quantity: quantity ? quantity.quantityValue : product.quantities[0].quantityValue,
                unit: quantity ? quantity.quantityUnit : product.quantities[0].quantityUnit,
                price: quantity ? parseFloat(quantity.price) : parseFloat(product.discountedPrice),
                originalPrice: quantity ? parseFloat(quantity.originalPrice || product.originalPrice) : parseFloat(product.originalPrice),
                imageUrl: product.image,
            };

            const token = localStorage.getItem('token');

            if (!token) {
                alert('You need to log in first.');
                return;
            }

            try {
                const response = await fetch('https://m1wala1.onrender.com/add-to-cart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-auth-token': token,
                    },
                    body: JSON.stringify(item),
                });

                const data = await response.json();
                if (response.ok) {
                    alert('Product added to cart.');
                } else {
                    alert('Failed to add product to cart: ' + data.msg);
                }
            } catch (error) {
                console.error('Error adding item to cart:', error);
                alert('An error occurred while adding item to cart: ' + error.message);
            }
        }

        async function searchProducts(searchTerm) {
            try {
                const products = await fetchProducts();
                const productGrid = document.querySelector('.product-grid');
                productGrid.innerHTML = '';

                const filteredProducts = products.filter(product => product.name.toLowerCase().includes(searchTerm.toLowerCase()));

                if (filteredProducts.length === 0) {
                    productGrid.innerHTML = '<p>No products found.</p>';
                } else {
                    filteredProducts.forEach(product => {
                        const originalPrice = parseFloat(product.originalPrice);
                        const discountedPrice = parseFloat(product.discountedPrice);

                        if (isNaN(originalPrice) || isNaN(discountedPrice)) {
                            console.error('Invalid price data', product);
                            return;
                        }

                        const discountPercentage = calculateDiscountPercentage(originalPrice, discountedPrice);

                        const productItem = document.createElement('div');
                        productItem.className = 'product-item';

                        const productImage = document.createElement('img');
                        productImage.src = `${product.image}`;
                        productImage.alt = product.name;

                        const productName = document.createElement('h3');
                        productName.textContent = product.name;

                        const discountBadge = document.createElement('div');
                        discountBadge.className = 'discount';
                        discountBadge.textContent = `${discountPercentage}% OFF`;

                        const pricesDiv = document.createElement('div');
                        pricesDiv.className = 'prices';

                        const originalPriceElem = document.createElement('span');
                        originalPriceElem.className = 'original-price';
                        originalPriceElem.textContent = `₹${originalPrice.toFixed(2)}`;

                        const discountedPriceElem = document.createElement('span');
                        discountedPriceElem.className = 'discounted-price';
                        discountedPriceElem.textContent = `₹${discountedPrice.toFixed(2)}`;

                        const quantityDiv = document.createElement('div');
                        quantityDiv.className = 'quantity';

                        if (product.quantities && product.quantities.length > 1) {
                            quantityDiv.textContent = `${product.quantities[0].quantityValue} ${product.quantities[0].quantityUnit}`;

                            productItem.appendChild(discountBadge);
                            productItem.appendChild(productImage);
                            productItem.appendChild(productName);
                            productItem.appendChild(quantityDiv);
                            productItem.appendChild(pricesDiv);

                            const optionsButton = document.createElement('button');
                            optionsButton.textContent = 'Options';
                            optionsButton.onclick = () => showProductOptions(product);
                            productItem.appendChild(optionsButton);
                        } else {
                            const productButton = document.createElement('button');
                            productButton.textContent = 'Add to Cart';
                            productButton.onclick = () => addToCart(product);

                            if (product.quantities && product.quantities.length === 1) {
                                quantityDiv.textContent = `${product.quantities[0].quantityValue} ${product.quantities[0].quantityUnit}`;
                            }

                            productItem.appendChild(discountBadge);
                            productItem.appendChild(productImage);
                            productItem.appendChild(productName);
                            productItem.appendChild(quantityDiv);
                            productItem.appendChild(pricesDiv);
                            productItem.appendChild(productButton);
                        }

                        pricesDiv.appendChild(originalPriceElem);
                        pricesDiv.appendChild(discountedPriceElem);

                        if (!product.available) {
                            const notAvailableOverlay = document.createElement('div');
                            notAvailableOverlay.className = 'not-available';
                            notAvailableOverlay.textContent = 'Product Not Available';
                            productItem.appendChild(notAvailableOverlay);
                        }

                        productGrid.appendChild(productItem);
                    });
                }
            } catch (error) {
                console.error('Error searching products:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const categories = document.querySelectorAll('#categories li');
            categories.forEach(category => {
                category.addEventListener('click', () => {
                    renderSubcategories(category.dataset.category);
                });
            });

            const modal = document.getElementById('productOptionsModal');
            const closeModalButton = modal.querySelector('.close');
            closeModalButton.onclick = () => {
                modal.style.display = 'none';
            };

            window.onclick = (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            };

            const searchInput = document.getElementById('search');
            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    searchProducts(searchTerm);
                } else {
                    // Show the first category and its first subcategory products by default
                    const firstCategory = Object.keys(subcategories)[0];
                    if (firstCategory) {
                        renderSubcategories(firstCategory);
                    }
                }
            });

            // Show the first category and its first subcategory products by default
            const firstCategory = Object.keys(subcategories)[0];
            if (firstCategory) {
                renderSubcategories(firstCategory);
            }
        });
    </script>
</body>
</html>
