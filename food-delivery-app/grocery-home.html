<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="m1wala" />
    <meta name="keywords" content="m1wala" />
    <meta name="author" content="m1wala" />
    <link rel="icon" href="/assets/images/logo/favicon.png" type="image/x-icon" />
    <title>m1wala instamart</title>
    <link rel="apple-touch-icon" href="/assets/images/logo/favicon.png" />
    <meta name="theme-color" content="#ff8d2f" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-title" content="m1wala" />
    <meta name="msapplication-TileImage" content="/assets/images/logo/favicon.png" />
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <title>Grocery Shopping</title>
    <style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    header {
    background-color: #205dee;
    color: #fff;
    padding: 10px;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 1000;
}

.header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
}

.header-top h1 {
    margin: 0;
    font-size: 1.5em;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
}
    
    .logo {
        width: 50px;
        height: 50px;
        cursor: pointer;
    }
    
    #banner-container {
        display: flex;
        overflow: hidden;
    }
    
    .banner {
        min-width: 100%;
        transition: transform 0.5s ease;
    }
    
    .banner img {
        display: block;
        max-width: 100%;
        height: auto;
    }
    
    #search {
        padding: 5px;
        width: 80%;
        margin-top: 10px;
    }
    
    .category-grid {
        flex-grow: 1;
        padding: 20px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }
    
    .category-item {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        text-align: center;
        background-color: #fff;
    }
    
    .category-item img {
        max-width: 100%;
        height: auto;
        border-bottom: 1px solid #ddd;
        padding-bottom: 10px;
        margin-bottom: 10px;
    }
    
    #content {
            display: flex;
            height: calc(100vh - 180px);
        }
        .subcategory-grid {
            width: 250px;
            background-color: #f8f8f8;
            border-right: 1px solid #ddd;
            padding: 10px;
            overflow-y: auto;
            flex-shrink: 0;
            height: 100%;
        }
        .subcategory-item {
            padding: 10px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            border-radius: 5px;
            display: flex;
            align-items: center;
            text-decoration: none;
            color: #000;
            background-color: #fff;
        }
        .subcategory-item:hover, .subcategory-item.active {
            background-color: #e0e0e0;
        }
        .subcategory-item img {
            max-width: 30px;
            margin-right: 10px;
        }
        .product-grid {
            flex-grow: 1;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            overflow-y: auto;
        }
        .product-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }
        .product-item img {
            max-width: 100%;
            height: auto;
            border-bottom: 1px solid #ddd;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        .product-item .discount {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: #ff5c5c;
            color: white;
            padding: 5px;
            border-radius: 5px;
            font-weight: bold;
        }
        .product-item .prices {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .product-item .original-price {
            text-decoration: line-through;
            color: #888;
        }
        .product-item .discounted-price {
            color: #28a745;
            font-weight: bold;
        }
        .product-item button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        .product-item button:hover {
            background-color: #218838;
        }
        .product-item.unavailable {
            background-color: #f8d7da;
            opacity: 0.6;
            pointer-events: none;
        }
        .product-item .not-available {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.8);
            color: red;
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
        }
    .navbar-menu {
        background-color: #fff;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        justify-content: space-around;
        padding: 10px 0;
        box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        z-index: 1000;
    }
    
    .navbar-menu ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        width: 100%;
        justify-content: space-around;
    }
    
    .navbar-menu li {
        flex: 1;
        text-align: center;
    }
    
    .navbar-menu a {
        color: #228b22;
        text-decoration: none;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    .navbar-menu a.active {
        color: #28a745;
    }
    
    .navbar-menu img {
        max-width: 24px;
        margin-bottom: 5px;
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
        padding-top: 60px;
    }
    
    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        box-sizing: border-box;
        max-width: 600px;
    }
    
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    
    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    
    .quantity-option {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        border-bottom: 1px solid #ccc;
        padding-bottom: 10px;
    }
    
    .quantity-option span {
        margin: 0 10px;
    }
    
    .quantity-option .prices {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .quantity-option .original-price {
        text-decoration: line-through;
        color: #888;
    }
    
    .quantity-option .discounted-price {
        color: #28a745;
        font-weight: bold;
    }
    
    .quantity-option button {
        background-color: #4CAF50;
        border: none;
        color: white;
        padding: 5px 10px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.3s;
        position: relative; /* Ensure it is positioned relative to its container */
        z-index: 10; 
    }
    
    .quantity-option button:hover {
        background-color: #45a049;
    }
    
    .item-total {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background-color: #28a745;
        color: white;
        font-weight: bold;
    }
    
    .item-total span {
        font-size: 1.2em;
    }
    
    .cart-container {
        width: 300px;
        border: 1px solid #ccc;
        padding: 10px;
        margin: 20px auto;
        max-height: calc(100vh - 150px); /* Adjust to ensure navbar is visible */
        overflow-y: auto;
    }
    
    .cart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .review-container {
        display: none;
        margin-top: 10px;
    }
    
    .review-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 0;
        border-bottom: 1px solid #eee;
    }
    
    .review-item span {
        flex: 1;
    }
    
    .review-item button {
        background-color: #f0f0f0;
        border: none;
        padding: 5px;
        margin: 0 5px;
        cursor: pointer;
    }
    
    .review-item button:disabled {
        cursor: not-allowed;
    }
    
    .review-item img {
        width: 50px;
        height: 50px;
        object-fit: cover;
    }
    
    #go-to-cart {
        display: block;
        width: 100%;
        padding: 10px;
        background-color: #007bff;
        color: #fff;
        border: none;
        cursor: pointer;
        text-align: center;
    }
    
    #go-to-cart:hover {
        background-color: #0056b3;
    }
    
    .popup-cart-container {
        background-color: #fff;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        justify-content: space-around;
        padding: 10px 0;
        box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        z-index: 1000;
    }    
    </style>
</head>
<body>
    <header>
        <div class="header-top">
            <img src="https://via.placeholder.com/150x50.png?text=Logo" alt="Logo" class="logo" onclick="window.location.href='/index.html'">
            <h1>Grocery Shopping</h1>
        </div>
        <div id="banner-container">
            <div class="banner"><img src="https://via.placeholder.com/728x90.png?text=Promotional+Banner+1" alt="Promotional Banner 1"></div>
            <div class="banner"><img src="https://via.placeholder.com/728x90.png?text=Promotional+Banner+2" alt="Promotional Banner 2"></div>
            <div class="banner"><img src="https://via.placeholder.com/728x90.png?text=Promotional+Banner+3" alt="Promotional Banner 3"></div>
        </div>
        <input type="text" id="search" placeholder="Search...">
    </header>
    <div id="content">
        <div class="container">
            <div id="subcategory-grid" class="subcategory-grid"></div>
            <div id="product-grid" class="product-grid"></div>
        </div>
    </div>
    <div class="navbar-menu">
        <ul>
            <li class="active">
                <a href="grocery-home.html" class="icon"><span>Grocery</span></a>
            </li>
            <li>
                <a href="cart.html" class="icon"><span>Cart</span></a>
            </li>
            <li>
                <a href="profile.html" class="icon"><span>Profile</span></a>
            </li>
        </ul>
    </div>
    <div id="productOptionsModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="productOptionsContent"></div>
        </div>
    </div>
    <div class="popup-cart-container" id="cart-container">
        <div class="cart-header">
            <span>Cart (<span id="cart-count">0</span>)</span>
            <button id="toggle-cart">⯆</button>
        </div>
        <div class="review-container" id="review-container" style="display: none;">
            <!-- Items will be dynamically added here -->
        </div>
        <button id="go-to-cart">Go to Cart</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('token');

    if (!token) {
        displayLoginMessage();
        return;
    }

    try {
        await fetchCartItems(token);
    } catch (error) {
        console.error('Error fetching cart items:', error);
    }

    try {
        await renderCategories();
    } catch (error) {
        console.error('Error fetching categories:', error);
    }

    const searchInput = document.getElementById('search');
    if (searchInput) {
        searchInput.addEventListener('input', handleSearchInput);
    }

    const urlParams = new URLSearchParams(window.location.search);
    const categoryId = urlParams.get('categoryId');
    const subcategoryId = urlParams.get('subcategoryId');
    const productId = urlParams.get('productId');

    if (categoryId) {
        try {
            await navigateToSubcategories(categoryId, subcategoryId, productId);
        } catch (error) {
            console.error('Error navigating to subcategories:', error);
        }
    }

    const scrollPos = localStorage.getItem('scrollPos');
    if (scrollPos) {
        window.scrollTo(0, parseInt(scrollPos));
        localStorage.removeItem('scrollPos');
    }

    const modal = document.getElementById('productOptionsModal');
    const span = document.querySelector('.close');
    if (span) {
        span.onclick = function() {
            modal.style.display = 'none';
        };
    }
    window.onclick = function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    };

    let currentBannerIndex = 0;
    const banners = document.querySelectorAll('.banner');
    if (banners.length > 0) {
        setInterval(() => {
            currentBannerIndex = (currentBannerIndex + 1) % banners.length;
            banners.forEach((banner, index) => {
                banner.style.transform = `translateX(-${currentBannerIndex * 100}%)`;
            });
        }, 5000);
    }
});

async function fetchCartItems(token) {
    try {
        const response = await fetch('https://m1wala1.onrender.com/api/cart', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'x-auth-token': token,
            }
        });

        if (response.status === 401) {
            throw new Error('Unauthorized access');
        }

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        displayCartItems(data.cartItems, data.subtotal);
        updateCartCount(data.cartItems.length); // Update cart count immediately
    } catch (error) {
        if (error.message === 'Unauthorized access') {
            alert('Session expired. Please log in.');
            window.location.href = '/login.html';
        } else {
            console.error('Error fetching cart items:', error);
            const cartItemsContainer = document.getElementById('cart-items-container');
            if (cartItemsContainer) {
                cartItemsContainer.innerText = 'Failed to load cart items';
            }
        }
    }
}

function displayCartItems(cartItems, subtotal) {
    const cartSection = document.getElementById('review-container');
    const cartContainer = document.getElementById('cart-container');

    if (!cartSection) {
        console.error('#review-container element not found.');
        return;
    }

    cartSection.innerHTML = '';

    if (cartItems.length === 0) {
        cartContainer.style.display = 'none'; // Hide cart container if empty
        return;
    }

    cartContainer.style.display = 'block'; // Show cart container if not empty

    cartItems.forEach(item => {
        const cartItem = document.createElement('div');
        cartItem.classList.add('cart-item');

        cartItem.innerHTML = `
            <img src="${item.imageUrl}" alt="${item.productName}">
            <div class="item-details">
                <span class="item-name">${item.productName}</span>
                <span class="item-quantity">Quantity: ${item.quantity}</span>
                <span class="item-unit-value">${item.quantityValue}${item.quantityUnit}/₹${item.price.toFixed(2)}</span>
                <button class="decrement-button" data-id="${item._id}">-</button>
                <button class="increment-button" data-id="${item._id}">+</button>
            </div>
        `;

        cartItem.querySelector('.decrement-button').addEventListener('click', () => {
            updateCartQuantity(item._id, item.quantity > 1 ? 'decrease' : 'remove');
        });

        cartItem.querySelector('.increment-button').addEventListener('click', () => {
            updateCartQuantity(item._id, 'increase');
        });

        cartSection.appendChild(cartItem);
    });

    const cartSubtotal = document.getElementById('cart-subtotal');
    if (cartSubtotal) {
        cartSubtotal.innerText = `Subtotal: ₹${subtotal}`;
    }
    
    const totalSavings = cartItems.reduce((acc, item) => acc + (item.originalPrice - item.price) * item.quantity, 0);
    const cartSavings = document.getElementById('cart-savings');
    if (cartSavings) {
        cartSavings.innerText = `You saved: ₹${totalSavings}`;
    }
}

async function updateCartQuantity(itemId, action, quantity = 1) {
    const token = localStorage.getItem('token');

    try {
        const response = await fetch(`https://m1wala1.onrender.com/api/cart/${itemId}/${action}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'x-auth-token': token,
            },
            body: JSON.stringify({ quantity })
        });

        if (response.status === 401) {
            alert('Session expired. Please log in.');
            window.location.href = '/login.html';
            return;
        }

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        displayCartItems(data.cartItems, data.subtotal);
        updateCartCount(data.cartItems.length); // Update cart count immediately
    } catch (error) {
        console.error(`Error updating cart item quantity (${action}):`, error);
    }
}

function updateCartCount(count) {
    const cartCount = document.getElementById('cart-count');
    cartCount.textContent = count;
}


function displayLoginMessage() {
    const cartItemsContainer = document.getElementById('cart-items-container');
    if (cartItemsContainer) {
        cartItemsContainer.innerText = 'Please log in to view your cart items.';
    }
}

async function fetchCategories() {
    try {
        const response = await fetch('https://m1wala1.onrender.com/api/categories');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return await response.json();
    } catch (error) {
        console.error('Error fetching categories:', error);
        return [];
    }
}

async function fetchSubcategories(categoryId) {
    try {
        const response = await fetch(`https://m1wala1.onrender.com/api/subcategories?categoryId=${categoryId}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return await response.json();
    } catch (error) {
        console.error('Error fetching subcategories:', error);
        return [];
    }
}

async function fetchProducts(subcategoryId) {
    try {
        const response = await fetch(`https://m1wala1.onrender.com/api/products?subcategoryId=${subcategoryId}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return await response.json();
    } catch (error) {
        console.error('Error fetching products:', error);
        return [];
    }
}

async function searchProducts(query) {
    try {
        const response = await fetch(`https://m1wala1.onrender.com/api/search?query=${query}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return await response.json();
    } catch (error) {
        console.error('Error searching products:', error);
        return [];
    }
}

function calculateDiscountPercentage(originalPrice, discountedPrice) {
    const discount = originalPrice - discountedPrice;
    const percentage = (discount / originalPrice) * 100;
    return Math.round(percentage);
}

function isValidObjectId(id) {
    return /^[0-9a-fA-F]{24}$/.test(id);
}

async function renderCategories(categoryIdToNavigate = null, subcategoryIdToNavigate = null, productIdToNavigate = null) {
    const categories = await fetchCategories();
    const content = document.getElementById('content');
    content.innerHTML = '<div class="category-grid"></div>';
    const categoryGrid = content.querySelector('.category-grid');

    categories.forEach(category => {
        const categoryItem = document.createElement('div');
        categoryItem.className = 'category-item';
        categoryItem.innerHTML = `
            <a href="#" onclick="navigateToSubcategories('${category._id}', '${subcategoryIdToNavigate}', '${productIdToNavigate}')">
                <img src="${category.image}" alt="${category.name}">
                <span>${category.name}</span>
            </a>
        `;
        categoryGrid.appendChild(categoryItem);

        if (categoryIdToNavigate && category._id === categoryIdToNavigate) {
            navigateToSubcategories(category._id, subcategoryIdToNavigate, productIdToNavigate);
        }
    });
}

async function navigateToSubcategories(categoryId, subcategoryIdToNavigate = null, productIdToNavigate = null) {
    const subcategories = await fetchSubcategories(categoryId);
    const content = document.getElementById('content');
    content.innerHTML = '<div class="subcategory-grid"></div><div class="product-grid"></div>';
    const subcategoryGrid = content.querySelector('.subcategory-grid');
    const productGrid = content.querySelector('.product-grid');

    subcategories.forEach(subcategory => {
        const subcategoryItem = document.createElement('div');
        subcategoryItem.className = 'subcategory-item';
        subcategoryItem.innerHTML = `
            <a href="#" onclick="renderProducts('${subcategory._id}', '${productIdToNavigate}')">
                <img src="${subcategory.image}" alt="${subcategory.name}">
                <span>${subcategory.name}</span>
            </a>
        `;
        subcategoryGrid.appendChild(subcategoryItem);

        if (subcategoryIdToNavigate && subcategory._id === subcategoryIdToNavigate) {
            renderProducts(subcategory._id, productIdToNavigate);
        }
    });

    if (subcategories.length > 0 && !subcategoryIdToNavigate) {
        renderProducts(subcategories[0]._id);
    }
}

async function renderProducts(subcategoryId, productIdToNavigate = null) {
    const products = await fetchProducts(subcategoryId);
    const productGrid = document.querySelector('.product-grid');
    if (productGrid) {
        productGrid.innerHTML = '';

        if (products.length === 0) {
            productGrid.innerHTML = '<p>No products found in this subcategory.</p>';
        } else {
            products.forEach(product => {
                renderProductItem(product);

                if (productIdToNavigate && product._id === productIdToNavigate) {
                    const productElement = document.querySelector(`[data-product-id="${product._id}"]`);
                    if (productElement) {
                        productElement.scrollIntoView({ behavior: 'smooth' });
                        productElement.classList.add('highlight');
                    }
                }
            });
        }
    } else {
        console.error('.product-grid element not found.');
    }
}

function renderProductItem(product) {
    const productItem = document.createElement('div');
    productItem.className = 'product-item';
    productItem.dataset.productId = product._id;

    const productImage = document.createElement('img');
    productImage.src = `${product.image}`;
    productImage.alt = product.name;

    const productName = document.createElement('h3');
    productName.textContent = product.name;

    const discountBadge = document.createElement('div');
    discountBadge.className = 'discount';
    const discountPercentage = calculateDiscountPercentage(product.quantities[0].originalPrice, product.quantities[0].discountedPrice);
    discountBadge.textContent = `${discountPercentage}% OFF`;

    const pricesDiv = document.createElement('div');
    pricesDiv.className = 'prices';

    const originalPriceElem = document.createElement('span');
    originalPriceElem.className = 'original-price';
    originalPriceElem.textContent = `₹${product.quantities[0].originalPrice.toFixed(2)}`;

    const discountedPriceElem = document.createElement('span');
    discountedPriceElem.className = 'discounted-price';
    discountedPriceElem.textContent = `₹${product.quantities[0].discountedPrice.toFixed(2)}`;

    const quantityDiv = document.createElement('div');
    quantityDiv.className = 'quantity-unit';
    quantityDiv.textContent = `${product.quantities[0].quantityValue}${product.quantities[0].quantityUnit}/₹${product.quantities[0].discountedPrice.toFixed(2)}`;

    const productButton = document.createElement('button');
    if (product.quantities.length > 1) {
        productButton.textContent = 'See Options';
        productButton.onclick = () => showProductOptions(product);
    } else {
        productButton.textContent = 'Add to Cart';
        productButton.onclick = () => addToCart(product, product.quantities[0]);
    }

    productItem.appendChild(discountBadge);
    productItem.appendChild(productImage);
    productItem.appendChild(productName);
    productItem.appendChild(quantityDiv);
    productItem.appendChild(pricesDiv);
    productItem.appendChild(productButton);

    pricesDiv.appendChild(originalPriceElem);
    pricesDiv.appendChild(discountedPriceElem);

    const productGrid = document.querySelector('.product-grid');
    if (productGrid) {
        productGrid.appendChild(productItem);
    } else {
        console.error('.product-grid element not found.');
    }
}

function showProductOptions(product) {
    const modal = document.getElementById('productOptionsModal');
    const content = document.getElementById('productOptionsContent');
    content.innerHTML = '';

    product.quantities.forEach(quantity => {
        const quantityDiv = document.createElement('div');
        quantityDiv.className = 'quantity-option';

        const quantityText = document.createElement('span');
        quantityText.textContent = `${quantity.quantityValue} ${quantity.quantityUnit}`;

        const originalPrice = parseFloat(quantity.originalPrice || product.originalPrice);
        const discountedPrice = parseFloat(quantity.discountedPrice || quantity.price);

        const pricesDiv = document.createElement('div');
        pricesDiv.className = 'prices';

        const originalPriceElem = document.createElement('span');
        originalPriceElem.className = 'original-price';
        originalPriceElem.textContent = `₹${originalPrice.toFixed(2)}`;

        const discountedPriceElem = document.createElement('span');
        discountedPriceElem.className = 'discounted-price';
        discountedPriceElem.textContent = `₹${discountedPrice.toFixed(2)}`;

        const addButton = document.createElement('button');
        addButton.textContent = 'Add to Cart';
        addButton.onclick = () => addToCart(product, quantity);

        pricesDiv.appendChild(originalPriceElem);
        pricesDiv.appendChild(discountedPriceElem);

        quantityDiv.appendChild(quantityText);
        quantityDiv.appendChild(pricesDiv);
        quantityDiv.appendChild(addButton);

        content.appendChild(quantityDiv);
    });

    modal.style.display = 'block';
}

function handleSearchInput(event) {
    const query = event.target.value.trim();
    if (query.length > 0) {
        searchProducts(query).then(products => {
            const productGrid = document.querySelector('.product-grid');
            if (productGrid) {
                productGrid.innerHTML = '';

                if (products.length === 0) {
                    productGrid.innerHTML = '<p>No products found for this search query.</p>';
                } else {
                    products.forEach(product => {
                        renderProductItem(product);
                    });
                }
            } else {
                console.error('.product-grid element not found.');
            }
        });
    } else {
        renderCategories();
    }
}

async function addToCart(product, quantity) {
    const token = localStorage.getItem('token');

    if (!token) {
        alert('You need to log in first.');
        window.location.href = '/login.html';
        return;
    }

    const item = {
        productName: product.name,
        quantity: quantity.quantityValue,
        unit: quantity.quantityUnit,
        price: quantity.discountedPrice,
        productId: product._id,
        quantityId: quantity._id,
        categoryId: product.categoryId,
        subcategoryId: product.subcategoryId,
        imageUrl: product.image
    };

    try {
        const response = await fetch('https://m1wala1.onrender.com/add-to-cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-auth-token': token,
            },
            body: JSON.stringify(item)
        });

        const data = await response.json();
        if (response.ok) {
            alert('Product added to cart.');
            await fetchCartItems(token);
        } else {
            alert('Session expired. Please log in. ' + (data.msg || data.errors[0].msg));
        }
    } catch (error) {
        console.error('Error adding item to cart:', error);
        alert('An error occurred. Please try again.');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    let cart = [];
    const cartCount = document.getElementById('cart-count');
    const reviewContainer = document.getElementById('review-container');
    const toggleCartButton = document.getElementById('toggle-cart');
    const goToCartButton = document.getElementById('go-to-cart');

    toggleCartButton.addEventListener('click', () => {
        reviewContainer.style.display = reviewContainer.style.display === 'none' ? 'block' : 'none';
    });

    goToCartButton.addEventListener('click', () => {
        window.location.href = '/cart.html';
    });

    function updateCartCount() {
        cartCount.textContent = cart.length;
    }

    function renderCart() {
        reviewContainer.innerHTML = '';
        if (!Array.isArray(cart)) {
            console.error('Cart is not an array:', cart);
            return;
        }
        cart.forEach((item, index) => {
            const itemContainer = document.createElement('div');
            itemContainer.className = 'review-item';

            const itemImage = document.createElement('img');
            itemImage.src = item.imageUrl || 'https://via.placeholder.com/50';
            itemImage.alt = item.productName || 'Unnamed item';
            itemContainer.appendChild(itemImage);

            const itemName = document.createElement('span');
            itemName.textContent = item.productName || 'Unnamed item';
            itemContainer.appendChild(itemName);

            const itemQuantity = document.createElement('span');
            itemQuantity.textContent = `Quantity: ${item.quantity || 0}`;
            itemContainer.appendChild(itemQuantity);

            const itemDetails = document.createElement('span');
            itemDetails.textContent = `${item.quantityValue || 0} ${item.quantityUnit || 'N/A'}/₹${item.price || 0}`;
            itemContainer.appendChild(itemDetails);

            const decrementButton = document.createElement('button');
            decrementButton.textContent = '-';
            decrementButton.addEventListener('click', () => {
                updateCartQuantity(item._id, item.quantity > 1 ? 'decrease' : 'remove');
            });
            itemContainer.appendChild(decrementButton);

            const incrementButton = document.createElement('button');
            incrementButton.textContent = '+';
            incrementButton.addEventListener('click', () => {
                updateCartQuantity(item._id, 'increase');
            });
            itemContainer.appendChild(incrementButton);

            reviewContainer.appendChild(itemContainer);
        });
    }

    async function updateCartQuantity(itemId, action, quantity = 1) {
        const token = localStorage.getItem('token');

        try {
            const response = await fetch(`https://m1wala1.onrender.com/api/cart/${itemId}/${action}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'x-auth-token': token,
                },
                body: JSON.stringify({ quantity })
            });

            if (response.status === 401) {
                alert('Session expired. Please log in.');
                window.location.href = '/login.html';
                return;
            }

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            cart = Array.isArray(data.cartItems) ? data.cartItems : [];
            updateCart();
        } catch (error) {
            console.error(`Error updating cart item quantity (${action}):`, error);
        }
    }

    function updateCart() {
        renderCart();
        updateCartCount();
    }

    const token = localStorage.getItem('token');
    if (!token) {
        console.error('No token found, authorization denied');
        return;
    }

    fetch('https://m1wala1.onrender.com/api/cart', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'x-auth-token': token
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        cart = Array.isArray(data.cartItems) ? data.cartItems : [];
        updateCart();
    })
    .catch(error => console.error('Error fetching cart items:', error));
});
    </script>
</body>
</html>
