<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Grocery</title>
    <style>
        .item {
            margin-bottom: 20px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }

        .item img {
            max-width: 300px;
            height: auto;
            margin-bottom: 10px;
        }

        #banner-form, #logo-form {
            margin-top: 20px;
            margin-bottom: 40px;
            padding: 20px;
            background-color: #e9ecef;
            border-radius: 5px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            background-color: #007bff;
            color: white;
        }

        header h1 {
            margin-bottom: 20px;
        }

        .banner-list, .logo-list {
            margin-top: 20px;
        }

        .hidden {
            display: none;
        }

        .product, .category, .subcategory {
            margin-bottom: 20px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }

        .product h3, .category p, .subcategory p {
            margin-bottom: 10px;
        }

        .product p {
            margin-bottom: 5px;
        }

        .product img, .category img, .subcategory img {
            max-width: 100px;
            height: auto;
            margin-bottom: 10px;
        }

        .product-actions, .category-actions, .subcategory-actions {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
        }

        .product-actions button, .category-actions button, .subcategory-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .product-actions button.edit, .category-actions button.edit, .subcategory-actions button.edit {
            background-color: #007bff;
            color: white;
            margin-right: 10px;
        }

        .product-actions button.delete, .category-actions button.delete, .subcategory-actions button.delete {
            background-color: #dc3545;
            color: white;
        }

        .product-actions button.toggle {
            background-color: #ffc107;
            color: white;
        }

        #product-form, #category-form, #subcategory-form {
            display: none;
        }

        .quantity-group {
            display: flex;
            gap: 10px;
        }

        .quantity-group select,
        .quantity-group input {
            flex: 1;
        }

        .quantity-entry {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        .quantity-entry .quantity-unit,
        .quantity-entry .quantity-value,
        .quantity-entry .quantity-price,
        .quantity-entry .quantity-original-price,
        .quantity-entry .quantity-discounted-price {
            flex: 1 1 200px;
        }

        #form-message {
            margin-top: 10px;
            color: green;
        }
    </style>
</head>
<body>
    <header>
        <h1>Admin - Manage Grocery</h1>
    </header>
    <main>
        <button id="add-category-btn">Add Category</button>
        <button id="add-subcategory-btn">Add Subcategory</button>
        <button id="add-product-btn">Add Product</button>

        <form id="category-form" enctype="multipart/form-data">
            <label for="category-name">Category Name:</label>
            <input type="text" id="category-name" name="category-name" required>
            <label for="category-image">Category Image:</label>
            <input type="file" id="category-image" name="category-image" accept="image/*" required>
            <button type="submit">Add Category</button>
        </form>

        <form id="subcategory-form" enctype="multipart/form-data">
            <label for="subcategory-name">Subcategory Name:</label>
            <input type="text" id="subcategory-name" name="subcategory-name" required>
            <label for="subcategory-image">Subcategory Image:</label>
            <input type="file" id="subcategory-image" name="subcategory-image" accept="image/*" required>
            <label for="category-id">Category:</label>
            <select id="category-id" name="category-id" required></select>
            <button type="submit">Add Subcategory</button>
        </form>

        <form id="product-form" enctype="multipart/form-data">
            <label for="product-name">Product Name:</label>
            <input type="text" id="product-name" name="name" required>
            <label for="product-category">Category:</label>
            <select id="product-category" name="categoryId" required></select>
            <label for="product-subcategory">Subcategory:</label>
            <select id="product-subcategory" name="subcategoryId" required></select>
            <label for="product-image">Product Image:</label>
            <input type="file" id="product-image" name="image" accept="image/*" required>
            
            <label for="original-price">Original Price:</label>
            <input type="number" id="original-price" name="originalPrice" step="0.01" required>
            <label for="discounted-price">Discounted Price:</label>
            <input type="number" id="discounted-price" name="discountedPrice" step="0.01" required>
          
            <div id="quantity-container">
              <div class="quantity-entry">
                <select class="quantity-unit" name="quantityUnit[]" required>
                  <option value="kg">kg</option>
                  <option value="grams">grams</option>
                  <option value="units">units</option>
                  <option value="ml">ml</option>
                </select>
                <input type="number" class="quantity-value" name="quantityValue[]" min="1" required>
                <input type="number" class="quantity-price" name="quantityPrice[]" step="1" placeholder="Price" required>
                <button type="button" class="remove-quantity">Remove</button>
              </div>
            </div>
            
            <button type="button" id="add-quantity">Add More Quantity</button>
            <button type="submit">Add Product</button>
            <button type="submit">Update Product</button>
          </form>
          

        <div class="category-list" id="category-list"></div>
        <div class="subcategory-list" id="subcategory-list"></div>
        <div class="product-list" id="product-list"></div>

        <button id="add-banner-btn">Add Banner</button>
        <button id="add-logo-btn">Add Logo</button>

        <form id="banner-form" class="hidden" enctype="multipart/form-data">
            <label for="banner-image">Banner Image:</label>
            <input type="file" id="banner-image" name="banner" accept="image/*" required>
            <button type="submit">Add Banner</button>
        </form>

        <form id="logo-form" class="hidden" enctype="multipart/form-data">
            <label for="logo-image">Logo Image:</label>
            <input type="file" id="logo-image" name="logo" accept="image/*" required>
            <button type="submit">Add Logo</button>
        </form>

        <div class="banner-list" id="banner-list"></div>
        <div class="logo-list" id="logo-list"></div>
    </main>
    <script>
document.addEventListener('DOMContentLoaded', function () {
    const addCategoryBtn = document.getElementById('add-category-btn');
    const addSubcategoryBtn = document.getElementById('add-subcategory-btn');
    const addProductBtn = document.getElementById('add-product-btn');
    const categoryForm = document.getElementById('category-form');
    const subcategoryForm = document.getElementById('subcategory-form');
    const productForm = document.getElementById('product-form');
    const bannerForm = document.getElementById('banner-form');
    const logoForm = document.getElementById('logo-form');
    const addBannerBtn = document.getElementById('add-banner-btn');
    const addLogoBtn = document.getElementById('add-logo-btn');

    if (addCategoryBtn) {
        addCategoryBtn.addEventListener('click', () => {
            categoryForm.style.display = 'block';
        });
    }

    if (addSubcategoryBtn) {
        addSubcategoryBtn.addEventListener('click', () => {
            subcategoryForm.style.display = 'block';
            renderCategoriesForSubcategory();
        });
    }

    if (addProductBtn) {
        addProductBtn.addEventListener('click', () => {
            productForm.style.display = 'block';
            renderCategoriesForProduct();
        });
    }

    if (addBannerBtn) {
        addBannerBtn.addEventListener('click', () => {
            bannerForm.classList.remove('hidden');
            logoForm.classList.add('hidden');
        });
    }

    if (addLogoBtn) {
        addLogoBtn.addEventListener('click', () => {
            logoForm.classList.remove('hidden');
            bannerForm.classList.add('hidden');
        });
    }

    const addQuantityBtn = document.getElementById('add-quantity');
    if (addQuantityBtn) {
        addQuantityBtn.addEventListener('click', function () {
            const quantityContainer = document.getElementById('quantity-container');
            if (quantityContainer) {
                const quantityEntry = document.createElement('div');
                quantityEntry.classList.add('quantity-entry');
                quantityEntry.innerHTML = `
                    <select class="quantity-unit" name="quantityUnit[]" required>
                        <option value="kg">kg</option>
                        <option value="grams">grams</option>
                        <option value="units">units</option>
                        <option value="ml">ml</option>
                    </select>
                    <input type="number" class="quantity-value" name="quantityValue[]" min="1" required>
                    <input type="text" class="quantity-price" name="quantityPrice[]" placeholder="Price" required>
                    <input type="text" class="quantity-original-price" name="quantityOriginalPrice[]" placeholder="Original Price" required>
                    <input type="text" class="quantity-discounted-price" name="quantityDiscountedPrice[]" placeholder="Discounted Price" required>
                    <button type="button" class="remove-quantity">Remove</button>
                `;
                quantityEntry.querySelector('.remove-quantity').addEventListener('click', function () {
                    quantityContainer.removeChild(quantityEntry);
                });
                quantityContainer.appendChild(quantityEntry);
            }
        });
    }

    async function fetchCategories() {
        try {
            const response = await fetch('https://m1wala1.onrender.com/api/categories');
            if (!response.ok) throw new Error('Failed to fetch categories');
            const data = await response.json();
            return Array.isArray(data) ? data : [];
        } catch (error) {
            console.error('Error fetching categories:', error);
            return [];
        }
    }

    async function fetchSubcategories(categoryId) {
        try {
            const response = await fetch(`https://m1wala1.onrender.com/api/subcategories/${categoryId}`);
            if (!response.ok) throw new Error('Failed to fetch subcategories');
            const data = await response.json();
            return Array.isArray(data) ? data : [];
        } catch (error) {
            console.error('Error fetching subcategories:', error);
            return [];
        }
    }

    async function fetchProducts(subcategoryId) {
        try {
            const response = await fetch(`https://m1wala1.onrender.com/api/products?subcategoryId=${subcategoryId}`);
            if (!response.ok) throw new Error('Failed to fetch products');
            const products = await response.json();
            displayProducts(products);
        } catch (error) {
            console.error('Error fetching products:', error);
        }
    }

    async function fetchBanners() {
        try {
            const response = await fetch('https://m1wala1.onrender.com/api/banners');
            if (!response.ok) throw new Error('Failed to fetch banners');
            const data = await response.json();
            return Array.isArray(data) ? data : [];
        } catch (error) {
            console.error('Error fetching banners:', error);
            return [];
        }
    }

    async function fetchLogos() {
        try {
            const response = await fetch('https://m1wala1.onrender.com/api/logos');
            if (!response.ok) throw new Error('Failed to fetch logos');
            const data = await response.json();
            return Array.isArray(data) ? data : [];
        } catch (error) {
            console.error('Error fetching logos:', error);
            return [];
        }
    }

    async function deleteProduct(id) {
        try {
            await fetch(`https://m1wala1.onrender.com/api/products/${id}`, { method: 'DELETE' });
            const selectedSubcategoryId = document.getElementById('product-subcategory').value;
            await fetchProducts(selectedSubcategoryId);
        } catch (error) {
            console.error('Error deleting product:', error);
        }
    }

    async function toggleAvailability(id) {
        try {
            await fetch(`https://m1wala1.onrender.com/api/products/${id}/toggle-availability`, { method: 'PATCH' });
            const selectedSubcategoryId = document.getElementById('product-subcategory').value;
            await fetchProducts(selectedSubcategoryId);
        } catch (error) {
            console.error('Error toggling product availability:', error);
        }
    }

    async function editProduct(id) {
        try {
            const response = await fetch(`https://m1wala1.onrender.com/api/products/${id}`);
            if (!response.ok) {
                throw new Error('Failed to fetch product details');
            }
            const product = await response.json();
            if (!product) {
                throw new Error('Product not found');
            }

            document.getElementById('product-name').value = product.name;
            document.getElementById('product-category').value = product.categoryId;
            document.getElementById('product-subcategory').value = product.subcategoryId;

            const quantityContainer = document.getElementById('quantity-container');
            quantityContainer.innerHTML = '';
            
            // Check if quantities is an array and has elements
            if (Array.isArray(product.quantities) && product.quantities.length > 0) {
                product.quantities.forEach(quantity => {
                    const quantityEntry = document.createElement('div');
                    quantityEntry.classList.add('quantity-entry');
                    quantityEntry.innerHTML = `
                        <select class="quantity-unit" name="quantityUnit[]" required>
                            <option value="kg" ${quantity.quantityUnit === 'kg' ? 'selected' : ''}>kg</option>
                            <option value="grams" ${quantity.quantityUnit === 'grams' ? 'selected' : ''}>grams</option>
                            <option value="units" ${quantity.quantityUnit === 'units' ? 'selected' : ''}>units</option>
                            <option value="ml" ${quantity.quantityUnit === 'ml' ? 'selected' : ''}>ml</option>
                        </select>
                        <input type="number" class="quantity-value" name="quantityValue[]" value="${quantity.quantityValue}" min="1" required>
                        <input type="number" class="quantity-price" name="quantityPrice[]" value="${quantity.price}" step="0.01" placeholder="Price" required>
                        <button type="button" class="remove-quantity">Remove</button>
                    `;
                    quantityEntry.querySelector('.remove-quantity').addEventListener('click', function () {
                        quantityContainer.removeChild(quantityEntry);
                    });
                    quantityContainer.appendChild(quantityEntry);
                });
            } else {
                const quantityEntry = document.createElement('div');
                quantityEntry.classList.add('quantity-entry');
                quantityEntry.innerHTML = `
                    <select class="quantity-unit" name="quantityUnit[]" required>
                        <option value="kg">kg</option>
                        <option value="grams">grams</option>
                        <option value="units">units</option>
                        <option value="ml">ml</option>
                    </select>
                    <input type="number" class="quantity-value" name="quantityValue[]" min="1" required>
                    <input type="number" class="quantity-price" name="quantityPrice[]" step="0.01" placeholder="Price" required>
                    <button type="button" class="remove-quantity">Remove</button>
                `;
                quantityEntry.querySelector('.remove-quantity').addEventListener('click', function () {
                    quantityContainer.removeChild(quantityEntry);
                });
                quantityContainer.appendChild(quantityEntry);
            }

            document.getElementById('product-form').style.display = 'block';
        } catch (error) {
            console.error('Error fetching product details:', error);
            alert('Error fetching product details: ' + error.message);
        }
    }

    async function deleteCategory(id) {
        try {
            await fetch(`https://m1wala1.onrender.com/api/categories/${id}`, { method: 'DELETE' });
            await renderCategories();
        } catch (error) {
            console.error('Error deleting category:', error);
        }
    }

    async function deleteSubcategory(id) {
        try {
            await fetch(`https://m1wala1.onrender.com/api/subcategories/${id}`, { method: 'DELETE' });
            const selectedCategoryId = document.getElementById('category-id').value;
            await renderSubcategories(selectedCategoryId);
        } catch (error) {
            console.error('Error deleting subcategory:', error);
        }
    }

    async function deleteBanner(filename) {
        try {
            await fetch(`https://m1wala1.onrender.com/api/banners/${filename}`, { method: 'DELETE' });
            alert('Banner deleted successfully!');
            renderBanners();
        } catch (error) {
            console.error('Error deleting banner:', error);
        }
    }

    async function deleteLogo(filename) {
        try {
            await fetch(`https://m1wala1.onrender.com/api/logos/${filename}`, { method: 'DELETE' });
            alert('Logo deleted successfully!');
            renderLogos();
        } catch (error) {
            console.error('Error deleting logo:', error);
        }
    }

    const renderCategories = async () => {
        const categories = await fetchCategories();
        const categoryList = document.getElementById('category-list');
        const categorySelect = document.getElementById('category-id');
        const productCategorySelect = document.getElementById('product-category');
        if (categoryList && categorySelect && productCategorySelect) {
            categoryList.innerHTML = '';
            categorySelect.innerHTML = '';
            productCategorySelect.innerHTML = '';

            categories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';
                categoryDiv.innerHTML = `
                    <img src="https://m1wala1.onrender.com${category.image}" alt="${category.name}">
                    <p>${category.name}</p>
                    <div class="category-actions">
                        <button class="delete-category" data-id="${category._id}">Delete</button>
                        <button class="view-subcategories" data-id="${category._id}">View Subcategories</button>
                    </div>
                `;
                categoryList.appendChild(categoryDiv);

                const option = document.createElement('option');
                option.value = category._id;
                option.textContent = category.name;
                categorySelect.appendChild(option);

                const productOption = document.createElement('option');
                productOption.value = category._id;
                productOption.textContent = category.name;
                productCategorySelect.appendChild(productOption);
            });

            categorySelect.addEventListener('change', async function () {
                const selectedCategoryId = categorySelect.value;
                await renderSubcategories(selectedCategoryId);
            });

            productCategorySelect.addEventListener('change', async function () {
                const selectedCategoryId = productCategorySelect.value;
                await renderSubcategories(selectedCategoryId);
            });

            if (categories.length > 0) {
                await renderSubcategories(categories[0]._id);
            }

            document.querySelectorAll('.view-subcategories').forEach(button => {
                button.addEventListener('click', function () {
                    const categoryId = this.dataset.id;
                    renderSubcategories(categoryId);
                });
            });
        }
    };

    const renderSubcategories = async (categoryId) => {
        const subcategories = await fetchSubcategories(categoryId);
        const subcategoryList = document.getElementById('subcategory-list');
        const subcategorySelect = document.getElementById('product-subcategory');
        if (subcategoryList && subcategorySelect) {
            subcategoryList.innerHTML = '';
            subcategorySelect.innerHTML = '';

            subcategories.forEach(subcategory => {
                const subcategoryDiv = document.createElement('div');
                subcategoryDiv.className = 'subcategory';
                subcategoryDiv.innerHTML = `
                    <img src="https://m1wala1.onrender.com${subcategory.image}" alt="${subcategory.name}">
                    <p>${subcategory.name}</p>
                    <div class="subcategory-actions">
                        <button class="delete-subcategory" data-id="${subcategory._id}">Delete</button>
                        <button class="view-products" data-id="${subcategory._id}">View Products</button>
                    </div>
                `;
                subcategoryList.appendChild(subcategoryDiv);

                const option = document.createElement('option');
                option.value = subcategory._id;
                option.textContent = subcategory.name;
                subcategorySelect.appendChild(option);
            });

            subcategorySelect.addEventListener('change', function () {
                const selectedSubcategoryId = subcategorySelect.value;
                fetchProducts(selectedSubcategoryId);
            });

            if (subcategories.length > 0) {
                fetchProducts(subcategories[0]._id);
            }

            document.querySelectorAll('.view-products').forEach(button => {
                button.addEventListener('click', function () {
                    const subcategoryId = this.dataset.id;
                    fetchProducts(subcategoryId);
                });
            });
        }
    };

    const renderCategoriesForSubcategory = async () => {
        const categories = await fetchCategories();
        const categorySelect = document.getElementById('category-id');
        if (categorySelect) {
            categorySelect.innerHTML = '';

            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category._id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });

            if (categories.length > 0) {
                renderSubcategories(categories[0]._id);
            }
        }
    };

    const renderCategoriesForProduct = async () => {
        const categories = await fetchCategories();
        const productCategorySelect = document.getElementById('product-category');
        if (productCategorySelect) {
            productCategorySelect.innerHTML = '';

            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category._id;
                option.textContent = category.name;
                productCategorySelect.appendChild(option);
            });

            if (categories.length > 0) {
                renderSubcategories(categories[0]._id);
            }
        }
    };

    const renderBanners = async () => {
        const banners = await fetchBanners();
        const bannerList = document.getElementById('banner-list');
        if (bannerList) {
            bannerList.innerHTML = '';
            banners.forEach(banner => {
                const bannerDiv = document.createElement('div');
                bannerDiv.className = 'item';
                bannerDiv.innerHTML = `
                    <img src="https://m1wala1.onrender.com/uploads/${banner.filename}" alt="Banner Image">
                    <button onclick="deleteBanner('${banner.filename}')">Delete</button>
                `;
                bannerList.appendChild(bannerDiv);
            });
        }
    };

    const renderLogos = async () => {
        const logos = await fetchLogos();
        const logoList = document.getElementById('logo-list');
        if (logoList) {
            logoList.innerHTML = '';
            logos.forEach(logo => {
                const logoDiv = document.createElement('div');
                logoDiv.className = 'item';
                logoDiv.innerHTML = `
                    <img src="https://m1wala1.onrender.com/uploads/${logo.filename}" alt="Logo Image">
                    <button onclick="deleteLogo('${logo.filename}')">Delete</button>
                `;
                logoList.appendChild(logoDiv);
            });
        }
    };

    const displayProducts = (products) => {
        const productList = document.getElementById('product-list');
        if (productList) {
          productList.innerHTML = '';
          if (Array.isArray(products)) {
              products.forEach(product => {
                const quantity = product.quantities[0] || {};
                productList.innerHTML += `
                  <div class="product">
                    <img src="https://m1wala1.onrender.com${product.image}" alt="${product.name}">
                    <h3>${product.name}</h3>
                    <p>${quantity.quantityValue || ''} ${quantity.quantityUnit || ''}</p>
                    <p>₹${quantity.originalPrice || 'N/A'} - ₹${quantity.discountedPrice || 'N/A'}</p>
                    <div class="product-actions">
                      <button class="edit" onclick="editProduct('${product._id}')">Edit</button>
                      <button class="delete" onclick="deleteProduct('${product._id}')">Delete</button>
                      <button class="toggle" onclick="toggleAvailability('${product._id}')">${product.available ? 'Mark as Unavailable' : 'Mark as Available'}</button>
                    </div>
                  </div>
                `;
              });
          } else {
              console.error('Invalid products data:', products);
          }
        }
    };

    document.getElementById('category-form').addEventListener('submit', async function (event) {
        event.preventDefault();
        const formData = new FormData();
        formData.append('name', document.getElementById('category-name').value);
        formData.append('image', document.getElementById('category-image').files[0]);

        try {
            await fetch('https://m1wala1.onrender.com/api/categories', {
                method: 'POST',
                body: formData,
            });
            renderCategories();
        } catch (error) {
            console.error('Error adding category:', error);
        }
    });

    document.getElementById('subcategory-form').addEventListener('submit', async function (event) {
        event.preventDefault();
        const formData = new FormData();
        formData.append('name', document.getElementById('subcategory-name').value);
        formData.append('image', document.getElementById('subcategory-image').files[0]);
        formData.append('categoryId', document.getElementById('category-id').value);

        try {
            await fetch('https://m1wala1.onrender.com/api/subcategories', {
                method: 'POST',
                body: formData,
            });
            const selectedCategoryId = document.getElementById('category-id').value;
            renderSubcategories(selectedCategoryId);
        } catch (error) {
            console.error('Error adding subcategory:', error);
        }
    });

    document.getElementById('product-form').addEventListener('submit', async function (event) {
        event.preventDefault();

        const formData = new FormData();
        formData.append('name', document.getElementById('product-name').value);
        formData.append('categoryId', document.getElementById('product-category').value);
        formData.append('subcategoryId', document.getElementById('product-subcategory').value);
        formData.append('image', document.getElementById('product-image').files[0]);
        formData.append('originalPrice', document.getElementById('original-price').value);
        formData.append('discountedPrice', document.getElementById('discounted-price').value);

        const quantities = [];
        document.querySelectorAll('.quantity-entry').forEach(entry => {
            quantities.push({
                quantityUnit: entry.querySelector('.quantity-unit').value,
                quantityValue: entry.querySelector('.quantity-value').value,
                price: entry.querySelector('.quantity-price').value,
            });
        });
        formData.append('quantities', JSON.stringify(quantities));

        try {
            const response = await fetch('https://m1wala1.onrender.com/api/products', {
                method: 'POST',
                body: formData,
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Unknown error occurred');
            }

            const data = await response.json();
            console.log('Product added successfully:', data);
            alert('Product added successfully!');
            const selectedSubcategoryId = document.getElementById('product-subcategory').value;
            fetchProducts(selectedSubcategoryId);
        } catch (error) {
            console.error('Error adding product:', error);
            alert('Error adding product: ' + error.message);
        }
    });

    renderCategories();
    renderBanners();
    renderLogos();
});

async function deleteProduct(id) {
    try {
        await fetch(`https://m1wala1.onrender.com/api/products/${id}`, { method: 'DELETE' });
        const selectedSubcategoryId = document.getElementById('product-subcategory').value;
        await fetchProducts(selectedSubcategoryId);
    } catch (error) {
        console.error('Error deleting product:', error);
    }
}

async function toggleAvailability(id) {
    try {
        await fetch(`https://m1wala1.onrender.com/api/products/${id}/toggle-availability`, { method: 'PATCH' });
        const selectedSubcategoryId = document.getElementById('product-subcategory').value;
        await fetchProducts(selectedSubcategoryId);
    } catch (error) {
        console.error('Error toggling product availability:', error);
    }
}

async function editProduct(id) {
    try {
        const response = await fetch(`https://m1wala1.onrender.com/api/products/${id}`);
        if (!response.ok) {
            throw new Error('Failed to fetch product details');
        }
        const product = await response.json();
        if (!product) {
            throw new Error('Product not found');
        }

        document.getElementById('product-name').value = product.name;
        document.getElementById('product-category').value = product.categoryId;
        document.getElementById('product-subcategory').value = product.subcategoryId;

        const quantityContainer = document.getElementById('quantity-container');
        quantityContainer.innerHTML = '';
        
        // Check if quantities is an array and has elements
        if (Array.isArray(product.quantities) && product.quantities.length > 0) {
            product.quantities.forEach(quantity => {
                const quantityEntry = document.createElement('div');
                quantityEntry.classList.add('quantity-entry');
                quantityEntry.innerHTML = `
                    <select class="quantity-unit" name="quantityUnit[]" required>
                        <option value="kg" ${quantity.quantityUnit === 'kg' ? 'selected' : ''}>kg</option>
                        <option value="grams" ${quantity.quantityUnit === 'grams' ? 'selected' : ''}>grams</option>
                        <option value="units" ${quantity.quantityUnit === 'units' ? 'selected' : ''}>units</option>
                        <option value="ml" ${quantity.quantityUnit === 'ml' ? 'selected' : ''}>ml</option>
                    </select>
                    <input type="number" class="quantity-value" name="quantityValue[]" value="${quantity.quantityValue}" min="1" required>
                    <input type="number" class="quantity-price" name="quantityPrice[]" value="${quantity.price}" step="0.01" placeholder="Price" required>
                    <button type="button" class="remove-quantity">Remove</button>
                `;
                quantityEntry.querySelector('.remove-quantity').addEventListener('click', function () {
                    quantityContainer.removeChild(quantityEntry);
                });
                quantityContainer.appendChild(quantityEntry);
            });
        } else {
            const quantityEntry = document.createElement('div');
            quantityEntry.classList.add('quantity-entry');
            quantityEntry.innerHTML = `
                <select class="quantity-unit" name="quantityUnit[]" required>
                    <option value="kg">kg</option>
                    <option value="grams">grams</option>
                    <option value="units">units</option>
                    <option value="ml">ml</option>
                </select>
                <input type="number" class="quantity-value" name="quantityValue[]" min="1" required>
                <input type="number" class="quantity-price" name="quantityPrice[]" step="0.01" placeholder="Price" required>
                <button type="button" class="remove-quantity">Remove</button>
            `;
            quantityEntry.querySelector('.remove-quantity').addEventListener('click', function () {
                quantityContainer.removeChild(quantityEntry);
            });
            quantityContainer.appendChild(quantityEntry);
        }

        document.getElementById('product-form').style.display = 'block';
    } catch (error) {
        console.error('Error fetching product details:', error);
        alert('Error fetching product details: ' + error.message);
    }
}

async function fetchProducts(subcategoryId) {
    try {
        const response = await fetch(`https://m1wala1.onrender.com/api/products?subcategoryId=${subcategoryId}`);
        if (!response.ok) throw new Error('Failed to fetch products');
        const products = await response.json();
        displayProducts(products);
    } catch (error) {
        console.error('Error fetching products:', error);
    }
}

const displayProducts = (products) => {
    const productList = document.getElementById('product-list');
    if (productList) {
        productList.innerHTML = '';
        if (Array.isArray(products)) {
            products.forEach(product => {
                const quantity = product.quantities[0] || {};
                productList.innerHTML += `
                    <div class="product">
                        <img src="https://m1wala1.onrender.com${product.image}" alt="${product.name}">
                        <h3>${product.name}</h3>
                        <p>${quantity.quantityValue || ''} ${quantity.quantityUnit || ''}</p>
                        <p>₹${quantity.originalPrice || 'N/A'} - ₹${quantity.discountedPrice || 'N/A'}</p>
                        <div class="product-actions">
                            <button class="edit" onclick="editProduct('${product._id}')">Edit</button>
                            <button class="delete" onclick="deleteProduct('${product._id}')">Delete</button>
                            <button class="toggle" onclick="toggleAvailability('${product._id}')">${product.available ? 'Mark as Unavailable' : 'Mark as Available'}</button>
                        </div>
                    </div>
                `;
            });
        } else {
            console.error('Invalid products data:', products);
        }
    }
};

// Fetch and display products on page load
document.addEventListener('DOMContentLoaded', async () => {
    const response = await fetch('https://m1wala1.onrender.com/api/products');
    if (response.ok) {
        const products = await response.json();
        displayProducts(products);
    } else {
        console.error('Failed to fetch products on page load');
    }
});
        async function fetchProducts(subcategoryId) {
            try {
                const response = await fetch(`https://m1wala1.onrender.com/api/products?subcategoryId=${subcategoryId}`);
                const products = await response.json();
                displayProducts(products);
            } catch (error) {
                console.error('Error fetching products:', error);
            }
        }
    </script>
</body>
</html>
